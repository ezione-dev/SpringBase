<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.akmz.springBase.admin.mapper.UserMapper">

    <!-- UserAdminViewResponse DTO에 매핑될 컬럼들을 정의하는 SQL 조각 -->
    <sql id="userAdminViewColumns">
        USER_NAME AS userName,
        EMAIL AS email,
        USE_YN AS useYn,
        LOGIN_FAILURE_COUNT AS loginFailureCount,
        LAST_FAILURE_TIMESTAMP AS lastFailureTimestamp
    </sql>

    <select id="findAll" resultType="UserAdminViewResponse">
        SELECT
            <include refid="userAdminViewColumns"/>
        FROM
            <include refid="BASE.userTable"/>
    </select>

    <resultMap id="userAdminResultMap" type="com.akmz.springBase.admin.model.dto.UserAdminViewResponse">
        <id property="userName" column="userName"/>
        <result property="email" column="email"/>
        <result property="useYn" column="useYn"/>
        <result property="loginFailureCount" column="loginFailureCount"/>
        <result property="lastFailureTimestamp" column="lastFailureTimestamp"/>
        <collection property="roles" ofType="java.lang.String">
            <result column="role"/>
        </collection>
    </resultMap>

    <select id="findAllWithRoles" resultMap="userAdminResultMap">
        SELECT
            u.USER_NAME            AS userName,
            u.EMAIL                AS email,
            u.USE_YN               AS useYn,
            u.LOGIN_FAILURE_COUNT  AS loginFailureCount,
            u.LAST_FAILURE_TIMESTAMP AS lastFailureTimestamp,
            r.ROLE_NAME            AS role
        FROM
            users u
        LEFT JOIN
            user_roles ur ON u.USER_NAME = ur.USER_NAME
        LEFT JOIN
            roles r ON ur.ROLE_ID = r.ROLE_ID
    </select>

</mapper>
